import socket
import sys
import time
import os

file = sys.argv[1]

ip = "172.20.20.21"
port = 6396

packet_sequence_init = [
	"0000000300000000000003fd00000000",
	"0000000300000000000003fa0000000400000001",
	"00000003000000000000043500000000",
	"0000000300000000000003f900000000",
	"0000000300000000000003f40000000400000000",
	"0000000300000000000003f50000000400000000",
	"0000000300000000000003f60000000400000000",
	"0000000300000000000003f70000000400000000",
	"00000003000000000000041e0000000400000000",
	"0000000300000000000003ec0000000400000001",
	"00000003000000000000040300000000",
	"0000000300000000000003f100000000",
	"0000000300000000000004040000000400000000",
	"0000000300000000000004060000001000000001000000010000000100000000",
	"00000003000000000000042200000000",
	"0000000300000000000004290000000400000000",
	"00000003000000000000040000000000"
]

packet_sequence_start_aquisition = [
	"00000003000000000000040d000000080000000000000001",
	"00000003000000000000040100000000",
	"00000003000000000000040100000000",
	"00000003000000000000040d000000080000000100000001",
	"0000000300000000000003ec0000000400000001",
	"0000000300000000000003f70000000400000000",
]

packet_sequence_stop_aquisition = [
	"00000003000000000000040100000000",
	"00000003000000000000040d000000080000000100000000",
	"00000003000000000000040d000000080000000000000000",
	"0000000300000000000003f100000000",
]

packet_sequence_unknown_reset_state = [
	"0000000300000000000003fa0000000400000004",
	"0000000300000000000003fa0000000400000001",
	"0000000300000000000003f40000000400000000",
	"0000000300000000000003f900000000",
	"0000000300000000000003f70000000400000000",
	"0000000300000000000004200000000400000000",
	"0000000300000000000003f000000000",
	"0000000300000000000004260000000400000000",
	"00000003000000000000042e0000000400000000",
	"00000003000000000000042e0000000400000001",
	"00000003000000000000042e0000000400000002",
	"00000003000000000000042e0000000400000003",
	"00000003000000000000042e0000000400000004",
	"00000003000000000000042e0000000400000005",
	"00000003000000000000042e0000000400000006",
	"00000003000000000000042e0000000400000007",
	"00000003000000000000042e0000000400000008",
	"00000003000000000000042e0000000400000009",
]


packet_fetch_aquisition = "0000000300000000000003f20000001000000000000000000000040000000400"

udp_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, 0)

def send_sequence(udp_sock, sequence):
	for packet_content in sequence:
		send_packet(udp_sock, packet_content)

def send_packet(udp_sock, packet_content):
	print("R: " + packet_content)
	sys.stdout.flush()
	udp_sock.sendto(bytearray.fromhex(packet_content), (ip, port))

	data, address = udp_sock.recvfrom(4096)
	print("A: " + data.hex())
	return data

def read_image(ip, port):
	total_image_size_bytes = 1024 * 1024 * 2
	tcp_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) 
	tcp_sock.connect((ip, port))
	bufall = bytes([])
	try: 
		while True:
			buf = tcp_sock.recv(1024)
			if not buf:
				break

			bufall += buf

			if len(bufall) >= total_image_size_bytes:
				break
	finally: 
		tcp_sock.close()

	return bufall


print("packet_sequence_init: ")
send_sequence(udp_sock, packet_sequence_init)

print("packet_sequence_start_aquisition: ")
send_sequence(udp_sock, packet_sequence_start_aquisition)

print("waiting 5 sec for aquisition:")
time.sleep(1)

print("packet_sequence_stop_aquisition: ")
send_sequence(udp_sock, packet_sequence_stop_aquisition)

data = send_packet(udp_sock, packet_fetch_aquisition)

tcp_port = int.from_bytes(data[22:24], "big")
image_buffer = read_image(ip, tcp_port)

with open(file, 'wb') as w:
    w.write(image_buffer)

print("packet_sequence_unknown_reset_state: ")
send_sequence(udp_sock, packet_sequence_unknown_reset_state)

udp_sock.close()
